#!/bin/bash


DAILY_TAG_SUFFIX="$(git log --pretty=format:'%h' -n 1)"
DEST=/tmp
COMPILE_DIRS=""

print-help() {
  cat <<EOF
Usage: $0 [options] [directories-to-compile]
Options:
    -a|--all                    compile all available targets
    -d|--dest                   destination directory to place archives/packages
    -t|--daily-version-tag      only for daily builds, add a tag version suffix
EOF
}

while [ -n "$1" ]; do
    param="$1"
    shift
    case "$param" in
        -a|--all)
            COMPILE_DIRS="$( find -name docker-compose.yml -exec dirname {} \; )"
            ;;
        -d|--dest)
            DEST="$1"; shift
            ;;
        -t|--daily-version-tag)
            DAILY_TAG_SUFFIX="$1"; shift
            ;;
        -h|--help)
            print-help
            exit 0
            ;;
        *)
            [ -r "$param/docker-compose.yml" ] && COMPILE_DIRS="$COMPILE_DIRS $param"
            ;;
    esac
done

echo "Compile dirs: $COMPILE_DIRS"
DAILY_TAG="$( date +%Y%m%d )-$DAILY_TAG_SUFFIX"


compile-dir() {
    echo "Compiling $@"
    cd "$@"
    DEST="$DEST" DAILY_TAG="$DAILY_TAG" docker-compose up
    cd ..
}


while read dir; do
    compile-dir "$dir"
done <<< "$COMPILE_DIRS"
