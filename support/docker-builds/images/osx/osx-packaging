#!/bin/bash
mkdir PlanetaryImager.app
make install DESTDIR="$PWD/PlanetaryImager.app"

fix_libraries() {
    binary="$1"
    python /fix_libraries.py \
                            --libs-dest PlanetaryImager.app/lib \
                            --otool x86_64-apple-darwin15-otool \
                            --install-name-tool x86_64-apple-darwin15-install_name_tool \
                            "$binary"

}

fix_libraries PlanetaryImager.app/bin/planetary_imager

cp -av /opt/local/libexec/qt5/plugins/platforms PlanetaryImager.app/bin
cp -av /opt/local/libexec/qt5/plugins/imageformats PlanetaryImager.app/bin

find PlanetaryImager.app/lib -type f -name *.dylib | while read file; do
    fix_libraries "$file"
done

find PlanetaryImager.app/lib/PlanetaryImager/drivers -type f -name *.so | while read file; do
    fix_libraries "$file"
done


find PlanetaryImager.app/bin -type f -name *.dylib | while read file; do
    fix_libraries "$file"
done

tar czf  PlanetaryImager.app.tar.gz PlanetaryImager.app
echo "CPACK_PACKAGE_FILENAME=PlanetaryImager.app.tar.gz" > package_name.cfg

