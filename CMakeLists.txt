cmake_minimum_required(VERSION 2.8.11)
enable_testing()
set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_SOURCE_DIR}/GuLinux-Commons/cmake)
include_directories(GuLinux-Commons GuLinux-Commons/c++)
project(PlanetaryImager)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11")
set(CMAKE_INCLUDE_CURRENT_DIR ON)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)
find_package(Qt5Widgets REQUIRED )
find_package(Qt5PrintSupport REQUIRED)

include_directories(${Qt5Widgets_INCLUDE_DIRS} ${Qt5PrintSupport_INCLUDE_DIRS})

add_definitions(-DSRC_DIR="${CMAKE_SOURCE_DIR}")

find_package(Boost REQUIRED)
find_package(OpenCV 2.3 REQUIRED )
find_package(QCustomPlot REQUIRED)

option(enable_qhy "Enable QHY Driver (default: ON)" ON) # TODO move again in drivers/CMakeLists.txt
option(enable_simulator "Enable fake driver simulator (default: OFF)" OFF)
if(enable_qhy)
  set(opencv_LINK_BUG On)
  set(enable_simulator Off)
  add_definitions(-DCV_LINK_BUG)
endif(enable_qhy)
message("workaround for cv link in libqhy: ${opencv_LINK_BUG}")

include_directories(${OpenCV_INCLUDE_DIRS})
include(FindPkgConfig)
pkg_check_modules(LIBUSB libusb-1.0 REQUIRED)
option(cflags_fpic "Use -fPIC for compilation " on)
if(cflags_fpic)
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC")
endif(cflags_fpic)

set(MAJOR_VERSION 0)
set(MINOR_VERSION 3)
set(PATCH_VERSION 0)

add_subdirectory(GuLinux-Commons/Qt)

execute_process(COMMAND "sed -i 's/“//g CMakeLists.txt" WORKING_DIRECTORY QHYCCD_Linux/)
execute_process(COMMAND "sed -i 's/”//g CMakeLists.txt" WORKING_DIRECTORY QHYCCD_Linux/)
add_subdirectory(QHYCCD_Linux)
include_directories(QHYCCD_Linux ${LIBUSB_INCLUDE_DIRS} ${Boost_INCLUDE_DIRS})
add_subdirectory(src)
add_subdirectory(tests)
add_subdirectory(files)
add_subdirectory(support)

SET(CPACK_PACKAGE_DESCRIPTION_SUMMARY "GuLinux.net Planetary Imager for Linux")
SET(CPACK_PACKAGE_VENDOR "GuLinux <marco@gulinux.net>")
SET(CPACK_PACKAGE_DESCRIPTION_FILE "${CMAKE_SOURCE_DIR}/README.md")
#SET(CPACK_RESOURCE_FILE_LICENSE "${CMAKE_SOURCE_DIR}/src/")
SET(CPACK_PACKAGE_VERSION_MAJOR "${MAJOR_VERSION}")
SET(CPACK_PACKAGE_VERSION_MINOR "${MINOR_VERSION}")
SET(CPACK_PACKAGE_VERSION_PATCH "${PATCH_VERSION}")
SET(CPACK_PACKAGE_CONTACT "marco@gulinux.net")
#SET(CPACK_STRIP_FILES "bin/planetary_imager")
SET(CPACK_GENERATOR DEB)
SET(CPACK_DEBIAN_PACKAGE_DEPENDS "libusb (>= 1.0-0), libqt5gui5 (>= 5.4.0), libqt5network5 (>= 5.4.0), libqt5widgets5 (>= 5.4.0)")

INCLUDE(CPack)